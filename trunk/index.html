<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Guerra no espa&ccedil;o</title>
  </head>
  <body>
  
	<h1>Guerra no espa&ccedil;o</h1>
	
	<table>

	<tr>
		<td>Pontos:</td>
		<td>Fase:</td>
		<td id = "campoVidas">Vidas 3</td>
	</tr>
	<tr>		
		<td colspan=3 ><canvas id="surface" width="640" height="480" style="background-color: #ccc;"></canvas></td>
	</tr>
    

<script type="text/javascript">

window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              window.oRequestAnimationFrame      ||
              window.msRequestAnimationFrame     ||
              function(/* function */ callback, /* DOMElement */ element){
                window.setTimeout(callback, 1000 / 60);
              };
})();

var canvas = document.getElementById("surface");
var ctx = canvas.getContext("2d");

function atualizarVidas(){
	var campoVida = document.getElementById("campoVidas");
	campoVida.innerHTML = 'Vidas: ' + qtdVidas;
	
}


//Naves
var qtdVidas = 3;
var fase = 1;
var pontos = 0;

//Velocidades 
var movimentoDevagar = 0.5;
var movimentoNormal = 2;
var movimentoRapido = 4;
var movimentoTiro = 3;

//Colisao
var distanciaColisao = 28;

var cod = 38;

var mapaX = new Array();
var mapaY = new Array();


var jogador = new NaveJogo();
jogador.x = canvas.width/2-23;
jogador.y = canvas.height/2;
jogador.angulo = 0;
jogador.tipo = 'jogador';
jogador.velocidade = movimentoNormal;
 
var inimigos = new Array();
inicializarInimigos();

function inicializarInimigos(){
	var listaInimigos = new Array();
	var qtdInimigos = 3;
	
	for(x = 0; x < qtdInimigos; x++){
		var inimigo = new NaveJogo();
		if(x == 1){
			inimigo.x = 297;
			inimigo.y = 380;
			inimigo.angulo = 0;
		}else if(x == 2){
			inimigo.x = 140;
			inimigo.y = 350;
			inimigo.angulo = 0;
		}else{
			inimigo.x = 255;
			inimigo.y = 330;
			inimigo.angulo = 0;
		}
		var tipoAviao = parseInt((Math.random() * 3));
		var movimentoDevagar = 0.5;
		switch(tipoAviao){
			case 0:{
				inimigo.tipo = 'devagar';
				inimigo.velocidade = movimentoDevagar;
				break;
			}
			case 1:{
				inimigo.tipo = 'devagarAtira';
				inimigo.velocidade = movimentoDevagar;
				break;
			}
			case 2:{
				inimigo.tipo = 'rapidoAtira';
				inimigo.velocidade = movimentoRapido;
				break;
			}
			
		}
		
		listaInimigos[x] = inimigo;		
	}
	inimigos = listaInimigos;
}

function NaveJogo() {
		this.x = 257;
		this.y = 380;
		this.angulo = 0;
		this.tipo = 'devagar';
		this.velocidade = movimentoNormal;
}


var i = 0;

for (x = 0; x <=canvas.width; x += 39) {
	mapaX[i] = x;
	i++;
}
i = 0;
for (y = 0; y <=canvas.height; y += 50) {					
	mapaY[i] = y;
	i++;
}
		


var planeImage = new Image();
planeImage.src = "red-airplane.png";

planeImage.addEventListener("load", desenha());
	
function desenha() {
		ctx.save();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		for (x = 0; x < mapaX.length; x += 1) {
			for (y = 0; y < mapaY.length; y += 1) {					
				ctx.fillRect(mapaX[x], mapaY[y], 5, 20);	
			}
		}
		ctx.restore();
}

function redesenharNave(nave){
	ctx.save();
	ctx.translate(nave.x, nave.y);
	ctx.rotate(nave.angulo * Math.PI/180);
	if(nave.tipo == 'jogador'){
		ctx.drawImage(planeImage, 0, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'devagar'){
		ctx.drawImage(planeImage, 52, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'devagarAtira'){
		ctx.drawImage(planeImage, 78, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'rapidoAtira'){
		ctx.drawImage(planeImage, 26, 0, 26, 25, -13, -13, 25, 26);
	}
	ctx.restore();
}
	
function colidiuX(nave){
	var colidiu = false;
		for ( i = 0; i < mapaX.length; i++ ){
			if( nave.x >= (mapaX[i] -13) & nave.x <= (mapaX[i] + 18)){					
				colidiu = true;
			}
		}
	return colidiu;
}
	
function colidiuY(nave){
	var colidiu = false;
		for ( i = 0; i < mapaY.length; i++ ){
			if ( nave.y >= (mapaY[i] -13) & nave.y <= (mapaY[i] + 33)){				
				colidiu = true;
			}
		}
	return colidiu;
}


function colidiuInimigo(){
	var colidiuInimigo = false;
	
	for(var i=0; i<inimigos.length; i++) {
		if((jogador.x + distanciaColisao >= inimigos[i].x && jogador.x-distanciaColisao <= inimigos[i].x) && (jogador.y+distanciaColisao >= inimigos[i].y && jogador.y-distanciaColisao <=inimigos[i].y)) {
			colidiuInimigo = true;
		}
	}
		
	if(colidiuInimigo) {
		qtdVidas = qtdVidas - 1;
		if(qtdVidas <= 0){
			gameOver();
			reiniciarJogo();
		}else{
			atualizarStatus();
			reiniciarJogo();
		}
	}
}
	
	

function atualizarStatus(){
	atualizarVidas();
}

function gameOver(){
	alert("Game-Over");
	qtdVidas = 3;
	fase = 1;
	pontos = 0;
	atualizarStatus();
}

function reiniciarJogador(){
	jogador.x = canvas.width/2-23;
	jogador.y = canvas.height/2;
	jogador.angulo = 0; 
}

function reiniciarInimigos(){
	var listaInimigos = new Array();
	for(x = 0; x < 3; x++){
		var inimigo = new NaveJogo();
		if(x == 1){
			inimigo.x = 297;
			inimigo.y = 380;
			inimigo.angulo = 0
		}else if(x == 2){
			inimigo.x = 140;
			inimigo.y = 350;
			inimigo.angulo = 0
		}else{
			inimigo.x = 255;
			inimigo.y = 330;
			inimigo.angulo = 0
		}
		
		
		
		
		listaInimigos[x] = inimigo;		
	}
	inimigos = listaInimigos;
}

function reiniciarJogo(){
	reiniciarJogador();
	reiniciarInimigos();
}
	
window.addEventListener("keydown", function(e) {
	pressionado = e.keyCode; 
	modificaAngulo(pressionado,jogador);
});


function modificaAngulo(valor, nave){
	if (valor == 38){ //seta cima
		if (!colidiuX(nave)){
			if(nave.y-nave.velocidade >= 15) {
				pressionado = -1;
				nave.angulo = 0;
				redesenharNave(nave);
			} 
		}			
	}
	if (valor == 40){ //seta baixo				
		if (!colidiuX(nave)){
			//Detecta se ira passar da area do canvas
			if(nave.y+nave.velocidade <= canvas.height-15) {
				pressionado = -1;
				nave.angulo = 180;
				redesenharNave(nave);
			}
		}
	}
	
	if(valor == 37) { //seta esquerda
		if (!colidiuY(nave)){
			//Detecta se ira passar da area do canvas
			if(nave.x-nave.velocidade >= 15) {
				pressionado = -1;
				nave.angulo = 270;
				redesenharNave(nave);
			}
		}
		
	}
	if(valor == 39) { //seta direita
		if (!colidiuY(nave)){
			if(nave.x + nave.velocidade <= canvas.width-15) {
				pressionado = -1;
				nave.angulo = 90;
				redesenharNave(nave);
			}
		}
		
	}
}
	
	var pressionado = -1;
	
	function movimentoInimigo(nave) {
		if(colidiuInimigo) {
			nave.y -= nave.velocidade;
		}
	}


	function movimentoJogador() {
		if(jogador.angulo == 0){
			jogador.y-= jogador.velocidade;
		}
		else if(jogador.angulo == 90){
			jogador.x += jogador.velocidade;
		}
		else if(jogador.angulo == 180){
			jogador.y+= jogador.velocidade;
		}
		else if(jogador.angulo == 270){
			jogador.x-= jogador.velocidade;
		}
	}


	
	function verificaLimiteTela(nave){
		if(nave.y >= canvas.height){
			nave.y = 2; 
		}else if(nave.y <= 0){
			nave.y = canvas.height; 
		}else if(nave.x >= canvas.width){
			nave.x = 0;
		}else if(nave.x <= 0){
			nave.x = canvas.width;
		}
	}	
	
	function loop() {
		
		while(pressionado != -1){
			if(jogador.angulo == 0){
				jogador.y -= jogador.velocidade;
			}
			else if(jogador.angulo == 90){
				jogador.x += jogador.velocidade;
			}
			else if(jogador.angulo == 180){
				jogador.y += jogador.velocidade;
			}
			else if(jogador.angulo == 270){
				jogador.x-= jogador.velocidade;
			}
			movimentoJogador();
			modificaAngulo(pressionado, jogador);
			redesenharNave(jogador);
		}
	  verificaLimiteTela(jogador);
	  desenha();
	  
	  redesenharNave(jogador);
	  for(i = 0; i < inimigos.length; i++){
	  	verificaLimiteTela(inimigos[i]);
	  	movimentoInimigo(inimigos[i]);
	  	colidiuInimigo();
	  	redesenharNave(inimigos[i]);
	  }
	  
	  movimentoJogador();
	  colidiuInimigo();
	  
	  
	  window.requestAnimFrame(loop, canvas);
	} 
	
			
	window.requestAnimFrame(loop, canvas);

	
</script>
  </body>
</html>