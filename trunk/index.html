<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Guerra no espa&ccedil;o</title>
  </head>
  <body>
  
	<h1>Guerra no espa&ccedil;o</h1>
	
	<table>

	<tr>
		<td id="campoPontos">Pontos:</td>
		<td id = "campoFase">Fase: 1</td>
		<td id = "campoVidas">Vidas: 3</td>
		<td></td>
	</tr>
	<tr>		
		<td colspan=3 ><canvas id="surface" width="640" height="480" style="background-color: #ccc;"></canvas></td>
		<td> 
		<b>Comandos:</b></br>
		<b>P </b>- Iniciar o jogo</br>
		<b>Barra de espa&ccedil;o </b>- Atirar
		
		</td>
	</tr>
	
    

<script type="text/javascript">
window.requestAnimFrame = (function(){
      return  window.requestAnimationFrame       ||
              window.webkitRequestAnimationFrame ||
              window.mozRequestAnimationFrame    ||
              window.oRequestAnimationFrame      ||
              window.msRequestAnimationFrame     ||
              function(/* function */ callback, /* DOMElement */ element){
                window.setTimeout(callback, 1000 / 60);
              };
})();

var canvas = document.getElementById("surface");
var ctx = canvas.getContext("2d");

function atualizarVidas(){
	var campoVida = document.getElementById("campoVidas");
	campoVida.innerHTML = 'Vidas: ' + qtdVidas; 	
}

function atualizarFase(){
	var campoFase = document.getElementById("campoFase");
	campoFase.innerHTML = 'Fase: ' + fase;
}

function atualizarPontos(){
	var campoPontos = document.getElementById("campoPontos");
	campoPontos.innerHTML = 'Pontos: ' + pontos;	
}


//Naves
var qtdVidas = 3;
var fase = 1;
var pontos = 0;
var metaPontuacao = 100;
//Velocidades 

var movimentoDevagar = 0.3;
var movimentoNormal = 1;
var movimentoRapido = 2;
var movimentoTiro = 3;

//Colisao
var distanciaColisao = 28;

var cod = 38;

var mapaX = new Array();
var mapaY = new Array();


var jogador = new NaveJogo();
jogador.x = canvas.width/2-23;
jogador.y = canvas.height/2;
jogador.angulo = 0;
jogador.tipo = 'jogador';
jogador.velocidade = movimentoNormal;
 
var inimigos = new Array();

var balas = new Array();

var pressionado = -1;


function gerarInimigo(){
	if (inimigos.length < 3){
		var inimigo = new NaveJogo();
		
		var posX = parseInt((Math.random() * (mapaX.length-2))) + 1;
		var posY= parseInt((Math.random() * (mapaY.length-2))) + 1;
		
		var angulos = [0, 90, 180, 270];
		inimigo.angulo = angulos[parseInt(Math.random() * 4)];
		
		switch(inimigo.angulo){
			case 0:{
				inimigo.x = mapaX[posX] + 20;
				inimigo.y = canvas.height;
				break;
			}
			case 90:{
				inimigo.x = 0;
				inimigo.y = mapaY[posY] + 34;
				break;
			}
			case 180:{
				inimigo.x = mapaX[posX] + 20;
				inimigo.y = 0;
				break;
			}
			case 270:{
				inimigo.x = canvas.width;
				inimigo.y = mapaY[posY] + 34;
				break;
			}	
		}	
		
		var tipoAviao = parseInt((Math.random() * 3));
		switch(tipoAviao){
			case 0:{
				inimigo.tipo = 'devagar';
				inimigo.velocidade = movimentoDevagar;
				break;
			}
			case 1:{
				inimigo.tipo = 'devagarAtira';
				inimigo.velocidade = movimentoDevagar;
				break;
			}
			case 2:{
				inimigo.tipo = 'rapidoAtira';
				inimigo.velocidade = movimentoRapido;
				break;
			}	
		}	
		inimigos[inimigos.length] = inimigo;	
	}
}

function NaveJogo() {
		this.x = 257;
		this.y = 380;
		this.angulo = 0;
		this.tipo = 'devagar';
		this.velocidade = movimentoNormal;
		this.balas = new Array();
}

function Bala(x, y, angulo, origemJogador){
	this.x = x;
	this.y = y;
	this.angulo = angulo;
	this.width = 3;
	this.height = 12;
	this.velocidade = movimentoTiro;
	this.origemJogador = origemJogador;
}


var i = 0;

//Inicializa o array do mapa do caminho
for (x = 0; x <=canvas.width; x += 39) {
	mapaX[i] = x;
	i++;
}
i = 0;
for (y = 0; y <=canvas.height; y += 50) {					
	mapaY[i] = y;
	i++;
}
		


var planeImage = new Image();
planeImage.src = "red-airplane.png";

planeImage.addEventListener("load", desenha());

//desenha o mapa do caminho na tela	
function desenha() {
		ctx.save();
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		for (x = 0; x < mapaX.length; x += 1) {
			for (y = 0; y < mapaY.length; y += 1) {					
				ctx.fillRect(mapaX[x], mapaY[y], 5, 20);	
			}
		}
		ctx.restore();
}

function redesenharNave(nave){
	ctx.save();
	ctx.translate(nave.x, nave.y);
	ctx.rotate(nave.angulo * Math.PI/180);
	if(nave.tipo == 'jogador'){
		ctx.drawImage(planeImage, 0, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'devagar'){
		ctx.drawImage(planeImage, 52, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'devagarAtira'){
		ctx.drawImage(planeImage, 78, 0, 26, 25, -13, -13, 25, 26);
	}else if(nave.tipo == 'rapidoAtira'){
		ctx.drawImage(planeImage, 26, 0, 26, 25, -13, -13, 25, 26);
	}
	ctx.restore();
}

function desenhaBalas(){

	verificaLimiteTelaBala();
	verificaColisaoBalaNoInimigo();
	for (i = 0; i < balas.length; i += 1) {
		if (balas[i].angulo == 0){
			balas[i].y -= balas[i].velocidade;
		}
		if (balas[i].angulo == 90){
			balas[i].x += balas[i].velocidade;
		}
		if (balas[i].angulo == 180){
			balas[i].y += balas[i].velocidade;
		}
		if (balas[i].angulo == 270){
			balas[i].x -= balas[i].velocidade;
		}		
		ctx.save();
		ctx.translate(balas[i].x, balas[i].y);
		ctx.rotate(balas[i].angulo * Math.PI/180);
		ctx.fillRect(0, 0, balas[i].width, balas[i].height);
		ctx.restore();
	}
}
	
function colidiuX(nave){
	var colidiu = false;
		for ( i = 0; i < mapaX.length; i++ ){
			if( nave.x >= (mapaX[i] -13) & nave.x <= (mapaX[i] + 18)){					
				colidiu = true;
			}
		}
	return colidiu;
}
	
function colidiuY(nave){
	var colidiu = false;
		for ( i = 0; i < mapaY.length; i++ ){
			if ( nave.y >= (mapaY[i] -13) & nave.y <= (mapaY[i] + 33)){				
				colidiu = true;
			}
		}
	return colidiu;
}


function colidiuInimigo(){
	var colidiuInimigo = false;
	
	for(var i=0; i<inimigos.length; i++) {
		if((jogador.x + distanciaColisao >= inimigos[i].x && jogador.x-distanciaColisao <= inimigos[i].x) && (jogador.y+distanciaColisao >= inimigos[i].y && jogador.y-distanciaColisao <=inimigos[i].y)) {
			colidiuInimigo = true;
		}
	}
		
	if(colidiuInimigo) {
		qtdVidas = qtdVidas - 1;
		if(qtdVidas <= 0){
			gameOver();
			reiniciarJogo();
		}else{
			atualizarStatus();
			reiniciarJogo();
		}
	}
}
	

function atualizarStatus(){
	atualizarVidas();
}

function gameOver(){
	alert("Game-Over");
	qtdVidas = 3;
	fase = 1;
	pontos = 0;
	atualizarStatus();
	clearInterval(intervaloGeracaoInimigo);
}

function reiniciarJogador(){
	jogador.x = canvas.width/2-23;
	jogador.y = canvas.height/2;
	jogador.angulo = 0; 
}

function reiniciarJogo(){
	reiniciarJogador();
	var intervaloGeracaoInimigo = window.setInterval(gerarInimigo, 6000);
}
	
window.addEventListener("keydown", function(e) {
	//Barra de espaÃ§o = 32
	// P = 80
	if (e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40){	
		pressionado = e.keyCode; 		
	}
	if (e.keyCode == 32){
		if(jogador.balas.length < 3){
			if (jogador.angulo == 0){
				var novaBala = new Bala(jogador.x - 2, jogador.y - 20, jogador.angulo, 1); 
				balas[balas.length] = novaBala;
				jogador.balas.push(novaBala);
			}
			if (jogador.angulo == 90){
				var novaBala = new Bala(jogador.x + 20, jogador.y - 2, jogador.angulo, 1); 
				balas[balas.length] = novaBala;
				jogador.balas.push(novaBala);
			}
			if (jogador.angulo == 180){
				var novaBala = new Bala(jogador.x + 2, jogador.y + 20, jogador.angulo, 1);
				balas[balas.length] = novaBala;
				jogador.balas.push(novaBala);
			}
			if (jogador.angulo == 270){
				var novaBala = new Bala(jogador.x - 20, jogador.y + 2, jogador.angulo, 1);
				balas[balas.length] = novaBala;
				jogador.balas.push(novaBala);
			}
		}
	}
});

function verificaColisaoBala(){
	for(i = 0 ; i < balas.length; i++){
		if(jogador.x == balas[i].x && jogador.y == balas[i].y){
			//colidiu			
		}
	}
}

function verificaColisaoBalaNoInimigo(){
	var rangeX = 10;
	var rangeY = 10;
	var atingido = 0; 
	for(i = 0 ; i < balas.length; i++){
		for(j = 0; j < inimigos.length; j++){
			if(balas[i].origemJogador == 1){
				if(balas[i].x > inimigos[j].x - rangeX && balas[i].x < inimigos[j].x + rangeX){
					if(balas[i].y > inimigos[j].y - rangeY && balas[i].y < inimigos[j].y + rangeY){

						if(inimigos[j].tipo == 'devagar'){
							pontos += 10;
						}else if(inimigos[j].tipo == 'devagarAtira'){
							pontos += 20;
						}else if(inimigos[j].tipo == 'rapidoAtira'){
							pontos += 30;
						}
						atualizarPontos();
						verificaFase();
						
						inimigos.splice(j, 1);
						atingido = 1;							
						gerarInimigo();						
					}
				}
			}
		}
		if(atingido == 1){
			balas.splice(i, 1);
			jogador.balas.shift();
			
		}
		atingido = 0;
	}
}


function modificaAngulo(valor, nave){
	if (valor == 38){ //seta cima
		if (!colidiuX(nave)){
			if(nave.y-nave.velocidade >= 15) {
				pressionado = -1;
				nave.angulo = 0;
				redesenharNave(nave);
			} 
		}			
	}
	if (valor == 40){ //seta baixo				
		if (!colidiuX(nave)){
			//Detecta se ira passar da area do canvas
			if(nave.y+nave.velocidade <= canvas.height-15) {
				pressionado = -1;
				nave.angulo = 180;
				redesenharNave(nave);
			}
		}
	}
	
	if(valor == 37) { //seta esquerda
		if (!colidiuY(nave)){
			//Detecta se ira passar da area do canvas
			if(nave.x-nave.velocidade >= 15) {
				pressionado = -1;
				nave.angulo = 270;
				redesenharNave(nave);
			}
		}
		
	}
	if(valor == 39) { //seta direita
		if (!colidiuY(nave)){
			if(nave.x + nave.velocidade <= canvas.width-15) {
				pressionado = -1;
				nave.angulo = 90;
				redesenharNave(nave);
			}
		}
		
	}
}

	function movimentoNave(nave) {
		if(nave.angulo == 0){
			nave.y-= nave.velocidade;
		}
		else if(nave.angulo == 90){
			nave.x += nave.velocidade;
		}
		else if(nave.angulo == 180){
			nave.y+= nave.velocidade;
		}
		else if(nave.angulo == 270){
			nave.x-= nave.velocidade;
		}
	}


	
	function verificaLimiteTela(nave){
		if(nave.y >= canvas.height){
			nave.y = 2; 
		}else if(nave.y <= 0){
			nave.y = canvas.height; 
		}else if(nave.x >= canvas.width){
			nave.x = 0;
		}else if(nave.x <= 0){
			nave.x = canvas.width;
		}
	}

	function verificaFase(){
		if(pontos >= metaPontuacao){
			metaPontuacao = metaPontuacao * 1.2;
			fase = fase + 1;
			atualizarFase();
		}
	}	

	function verificaLimiteTelaBala(){
			for(i = 0; i < balas.length; i++){
					if(balas[i].y >= canvas.height){
						if(balas[i].origemJogador){
							jogador.balas.shift();							
						}
						balas.shift();
					}else if(balas[i].y <= 0){
						if(balas[i].origemJogador){
							jogador.balas.shift();							
						}
						balas.shift();
					}else if(balas[i].x >= canvas.width){
						if(balas[i].origemJogador){
							jogador.balas.shift();							
						}
						balas.shift();
					}else if(balas[i].x <= 0){
						if(balas[i].origemJogador){
							jogador.balas.shift();							
						}
						balas.shift();
					}
			}
			
	}	
	
	function loop() {	
		
	  verificaLimiteTela(jogador);
	  desenha();
	  desenhaBalas();
	  for(i = 0; i < inimigos.length; i++){
	  	verificaLimiteTela(inimigos[i]);
	  	movimentoNave(inimigos[i]);
	  	colidiuInimigo();
	  	redesenharNave(inimigos[i]);
	  }
	  movimentoNave(jogador);
	  colidiuInimigo();
	  if (pressionado != -1){
			modificaAngulo(pressionado,jogador);
	  }
	  redesenharNave(jogador);
	  
	  window.requestAnimFrame(loop, canvas);
	} 
	
			
	window.requestAnimFrame(loop, canvas);
	gerarInimigo();
	var intervaloGeracaoInimigo = window.setInterval(gerarInimigo, 5000);

	
</script>
  </body>
</html>